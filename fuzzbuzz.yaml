base: ubuntu:16.04
language: c++
environment:
  - CXXFLAGS=-O1 -fno-omit-frame-pointer -gline-tables-only -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION -fsanitize-coverage=trace-pc-guard -fprofile-instr-generate -fcoverage-mapping
setup:
  - echo $CXXFLAGS
  - sudo apt-get update
  - sudo apt-get install -y bsdmainutils libboost-program-options-dev libboost-all-dev  libdb5.3++ software-properties-common  libqt5gui5 libqt5core5a libqt5dbus5 qttools5-dev qttools5-dev-tools libprotobuf-dev protobuf-compiler clang-format clang-tidy clang libc++-dev libc++1 libc++abi-dev libc++abi1 libclang-dev libclang1 libllvm-ocaml-dev libomp-dev libomp5 lldb llvm-dev llvm-runtime llvm autoconf libtool pkg-config openssl libssl-dev libevent-dev 
  - CC=clang CXX=clang++ ./autogen.sh
  - ./configure --enable-fuzz CC=$FUZZ_STANDALONE_CC CXX=$FUZZ_STANDALONE_CXX --with-sanitizers=address,undefined
  - AFL_HARDEN=1 cd src && make
  - git clone https://github.com/bitcoin-core/qa-assets /home/appuser/fuzzer/qa-assets
targets:
  - name: addrman-deserialize
    corpus: ./qa-assets/fuzz_seed_corpus/addrman_deserialize
    memory_limit: none
    harness:
      binary: ./src/test/fuzz/addrman_deserialize
  - name: address-deserialize
    corpus: ./qa-assets/fuzz_seed_corpus/address_deserialize
    memory_limit: none
    harness:
      binary: ./src/test/fuzz/address_deserialize
